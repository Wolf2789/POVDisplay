#include <Wire.h>

enum LedState { OFF = 0, ON = 1 };
class Display {
  private:
    static byte expander[];
    static byte remap[][8];
    static byte LEDs[];
  public:
    static void Update();
    static void SetLEDs(byte expander, byte LEDs);
    static void TurnLEDs(byte expander, byte LEDs, LedState state);
};

byte Display::expander[2] = { 0x21, 0x38 };
byte Display::LEDs[] = { 0, 0 };

void Display::SetLEDs(byte expander, byte LEDs) {
  Display::LEDs[expander] = LEDs;
}

void Display::TurnLEDs(byte expander, byte LEDs, LedState state) {
  if (state == ON)
    Display::LEDs[expander] |= LEDs;
  else
    Display::LEDs[expander] &= ~LEDs;
}

void Display::Update() {
  for (byte i = 0; i < 2; i++) {
    Wire.beginTransmission(Display::expander[i]);
    Wire.write(~Display::LEDs[i]); // we're expecting 255 to be all on, but to expander it means all off, so we need to invert our value
    Wire.endTransmission();
  }
}

int IR = 0;
byte IR_countdown = 0;
#define IR_THRESHOLD 900
#define IR_PIN_1 A2
bool doReset = true;
byte currentStep = 0;

void setup() {
  Wire.begin();
}

#define MAX_STEPS 130
byte image[][2] {
  {0x00,0x00},
  {0x00,0xfc},
  {0x60,0xfe},
  {0xe3,0x0e},
  {0x26,0x06},
  {0x26,0x0e},
  {0x67,0xce},
  {0xe3,0xec},
  {0xc1,0xf0},
  {0x00,0x70},
  {0x00,0x30},
  {0x00,0x00},
  {0x00,0x00},
  {0x00,0xec},
  {0x60,0xfe},
  {0xe3,0x32},
  {0x87,0x30},
  {0x06,0x30},
  {0x06,0x30},
  {0x87,0x30},
  {0xe3,0x32},
  {0x60,0xfe},
  {0x00,0xec},
  {0x00,0x00},
  {0x00,0x00},
  {0x60,0xee},
  {0xe3,0xfe},
  {0xe7,0x32},
  {0x66,0x32},
  {0x66,0x32},
  {0xe7,0x32},
  {0xc3,0x36},
  {0x00,0x36},
  {0x00,0xfe},
  {0x00,0xec},
  {0x00,0x00},
  {0x00,0xec},
  {0x00,0xec},
  {0x60,0xfe},
  {0xe3,0x32},
  {0x87,0x30},
  {0x06,0x30},
  {0x06,0x30},
  {0x87,0x30},
  {0xe3,0x32},
  {0x60,0xfe},
  {0x00,0xec},
  {0x00,0x00},
  {0x83,0x00},
  {0x03,0x00},
  {0x06,0x00},
  {0x06,0x00},
  {0x06,0x30},
  {0xe7,0xfe},
  {0xe7,0xfe},
  {0x06,0x30},
  {0x06,0x00},
  {0x06,0x00},
  {0x03,0x00},
  {0x83,0x00},
  {0x00,0x00},
  {0x00,0x00},
  {0x87,0x00},
  {0xc1,0x00},
  {0x60,0x30},
  {0x20,0xfe},
  {0x20,0xfe},
  {0x60,0x30},
  {0xc1,0x00},
  {0x87,0x00},
  {0x00,0x00},
  {0x00,0x00},
  {0x00,0xfe},
  {0xe7,0xfe},
  {0xe7,0x06},
  {0x00,0x06},
  {0x60,0x06},
  {0xe0,0x0c},
  {0x87,0x0c},
  {0x07,0x88},
  {0x00,0xc8},
  {0x00,0xe0},
  {0x00,0x70},
  {0x00,0x30},
  {0x00,0x10},
  {0x00,0x00},
  {0x00,0x00},
  {0x00,0xf8},
  {0x00,0xfe},
  {0x60,0x06},
  {0x83,0x06},
  {0x06,0x06},
  {0x06,0x06},
  {0x83,0x06},
  {0x60,0x06},
  {0x00,0xfe},
  {0x00,0xf8},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00},
  {0x00,0x00},
  {0x08,0x00}
};

void loop() {
  IR = analogRead(IR_PIN_1);
  if (IR_countdown > 0)
    IR_countdown--;
  else {
    if (IR > IR_THRESHOLD)
      doReset = true;
    else if (doReset) {
      doReset = false;
      currentStep = 0;
      IR_countdown = 10;
    }
  }

  Display::SetLEDs(0, image[step][0]);
  Display::SetLEDs(1, image[step][1]);

  Display::Update();
  if ((currentStep += 1) >= MAX_STEPS) {
    Display::SetLEDs(0, 0);
    Display::SetLEDs(1, 0);
    Display::Update();
  }
}